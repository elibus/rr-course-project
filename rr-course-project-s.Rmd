---
title: "Damages of natural events to economy and human lives in US"
output: 
  html_document:
    keep_md: true
---

```{r echo=FALSE}
# Format numeric values appropriately
# see http://stackoverflow.com/questions/30888631/knitr-displaying-digits-of-an-integer-without-scientific-notation
inline_hook <- function(x){
  if(is.numeric(x)){
    paste(format(x))
  }
}
knitr::knit_hooks$set(inline=inline_hook)
```

## Synopsis
This study uses the data between January 1996 and November 2011 provided by the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database to address two questions:

1. Across the United States, which types of events are most harmful with respect to population health?
2. Across the United States, which types of events have the greatest economic consequences?
 
To address the first question we look at the average of injuries and fatalities by extreme natural event type. Among those we select the top 5 event types.

To address the second one we take a similar approach looking at the average of the economic loss (expressed as damages to properties and crops) and selecting the top five events that caused the highest losses. 

Our analysis shows:

1. Tsunamis are the most harmful natural events to population health, followed by heat and hurricanes; 
2. Hurricanes as the worst extreme natural events in terms of economic losses scoring, on average, 30 times more that the second event type (storms).

## Data processing

### Required library
```{r warning=FALSE}
require(data.table)
require(lubridate)
require(stringdist)
require(dplyr)
require(lattice)
require(gridExtra)
```

### Data load
Here we load the data storm database selecting only relevant columns:
```{r}
# Download & load data
fileUrl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
destFile <- "repdata-data-StormData.csv.bz2"

# Download and unzip the dataset
if (!file.exists(destFile)) {
  res <- tryCatch(
    download.file(fileUrl, method = "libcurl", destfile = destFile),
    error = function(e)
      1
  )
}

# Read data - only relevant columns
colClasses = c(
  "NULL",
  "character",
  rep("NULL", 5),
  "character",  # EVTYPE
  rep("NULL", 14),
  rep("numeric", 3),
  "character", # PROPDMGEXP: Factor w/ 19 levels
  "numeric",
  "character", # CROPDMGEXP: Factor w/ 9 levels
  rep("NULL", 9)
)

df <- read.table(
  bzfile(destFile),
  sep = ",",
  header = TRUE,
  quote = "\"",
  colClasses = colClasses
)

colnames(df) <- c(
  "BGN_DATE",
  "EVTYPE",
  "FATALITIES",
  "INJURIES",
  "PROPDMG",
  "PROPDMGEXP",
  "CROPDMG",
  "CROPDMGEXP"
)

df$BGN_DATE <- as.Date(df$BGN_DATE, "%m/%d/%Y")
#df <- subset(df, BGN_DATE > as.Date("1996-01-01") )
```

### Data cleaning
Data in the storm database is not clean. The field EVTYPE, that records the type of extreme natural event, can assume values from a predefined list of event types. This list can be found at: http://www.nws.noaa.gov/directives/sym/pd01016005curr.pdf

Even though a predefined list of allowed values for the field EVTYPE exists the data is not clean and cannot be exaclty matched.
To match the highest possible number of correct event types against the official list we perform a number data transformation.

First, we load the official event types list

```{r}
# Official event types
evtypesFile <- "evtypes.csv"
evtypes <- readLines(evtypesFile)
evtypes <- toupper(evtypes)
```

Then we convert all strings to uppercase to avoid case matching issues. Fatalities and injuries are integers so they are converted too.
```{r}
df$EVTYPE <- toupper(df$EVTYPE)

df$FATALITIES <- as.integer(df$FATALITIES)
df$INJURIES   <- as.integer(df$INJURIES)

df$PROPDMGEXP <- toupper(df$PROPDMGEXP)
df$CROPDMGEXP <- toupper(df$CROPDMGEXP)
```

Field PROPDMGEXP and CROPDMGEXP record the exponent of the numeric value found in the field PROPDMG and CROPDMG. We want to have a plain number to ease computation and plotting. We do this using the following function and applying it to PROPDMG and CROPDMG columns:
```{r}
# Functions
apply_exp <- function(value, exp) {
  switch(
    exp,
    H={
      return(value * 100);
    },
    K={
      return(value * 1000);
    },
    M={
      return(value * 1000000);
    },
    B={
      return(value * 1000000000);
    },
    "0"={
      return(value);
    },
    "1"={
      return(value * 10);
    },
    "2"={
      return(value * 10^2);
    },
    "3"={
      return(value * 10^3);
    },
    "4"={
      return(value * 10^4);
    },
    "5"={
      return(value * 10^5);
    },
    "6"={
      return(value * 10^6);
    },
    "7"={
      return(value * 10^7);
    },
    "8"={
      return(value * 10^7);
    },
    "9"={
      return(value * 10^7);
    },
    {
      return(value);
    }
  )
}

df$PROPDMG <- mapply(apply_exp, df$PROPDMG, df$PROPDMGEXP)
df$CROPDMG <- mapply(apply_exp, df$CROPDMG, df$CROPDMGEXP)
```

The events in the storm database start in the year 1950 and end in November 2011. In the earlier years of the database there are generally fewer events recorded, most likely due to a lack of good records. In particular, only Tornados were recorded until January 1996. Data cannot be used for comparison

## Results